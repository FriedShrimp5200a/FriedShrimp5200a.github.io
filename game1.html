<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ジャイロ玉転がし迷路</title>
    <!-- 物理演算エンジン Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* スクロール禁止 */
            background-color: #222;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            touch-action: none; /* ピンチズームなどを無効化 */
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* UIオーバーレイ（スタート画面・結果画面） */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: white;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #ffd700;
        }

        p {
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.5;
            padding: 0 20px;
        }

        button {
            padding: 15px 40px;
            font-size: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* PC用操作ガイド */
        #pc-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: rgba(255,255,255,0.3);
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <h1 id="title-text">玉転がし迷路</h1>
        <p id="desc-text">
            スマホを傾けてボールを転がし<br>
            緑色のゴールを目指そう！<br>
            <span style="font-size:0.8em; color:#aaa;">(赤い穴には落ちないでね)</span>
        </p>
        <button id="start-btn">ゲーム開始 (センサー許可)</button>
    </div>

    <div id="pc-hint">PC: 矢印キーで操作</div>

    <script>
        // Matter.js のモジュール読み込み
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body,
              Events = Matter.Events,
              Composite = Matter.Composite;

        // グローバル変数
        let engine, render, runner;
        let ball;
        let width, height;
        let isGameActive = false;
        const WALL_THICKNESS = 40;
        
        // UI要素
        const uiLayer = document.getElementById('ui-layer');
        const startBtn = document.getElementById('start-btn');
        const titleText = document.getElementById('title-text');
        const descText = document.getElementById('desc-text');

        // ゲーム初期化
        function initGame() {
            width = window.innerWidth;
            height = window.innerHeight;

            // エンジンの作成
            engine = Engine.create();
            engine.world.gravity.y = 0; // 初期重力はゼロ
            engine.world.gravity.x = 0;

            // レンダラーの作成
            const container = document.getElementById('canvas-container');
            render = Render.create({
                element: container,
                engine: engine,
                options: {
                    width: width,
                    height: height,
                    wireframes: false, // 色付き表示
                    background: '#222'
                }
            });

            // 壁と迷路の生成
            createLevel();

            // レンダラーとエンジンの実行
            Render.run(render);
            runner = Runner.create();
            Runner.run(runner, engine);

            // 衝突判定イベント
            Events.on(engine, 'collisionStart', handleCollisions);
            
            // リサイズ対応
            window.addEventListener('resize', handleResize);

            // キーボード操作（PCデバッグ用）
            window.addEventListener('keydown', handleKeyboard);
        }

        // レベル生成（壁、ゴール、罠、ボール）
        function createLevel() {
            World.clear(engine.world);
            Engine.clear(engine);

            // 画面外枠の壁
            const walls = [
                Bodies.rectangle(width/2, -WALL_THICKNESS/2, width, WALL_THICKNESS, { isStatic: true, render: { fillStyle: '#555' } }), // 上
                Bodies.rectangle(width/2, height + WALL_THICKNESS/2, width, WALL_THICKNESS, { isStatic: true, render: { fillStyle: '#555' } }), // 下
                Bodies.rectangle(width + WALL_THICKNESS/2, height/2, WALL_THICKNESS, height, { isStatic: true, render: { fillStyle: '#555' } }), // 右
                Bodies.rectangle(-WALL_THICKNESS/2, height/2, WALL_THICKNESS, height, { isStatic: true, render: { fillStyle: '#555' } })  // 左
            ];

            // 迷路の障害物（簡易的な配置）
            const obstacles = [
                Bodies.rectangle(width * 0.3, height * 0.3, width * 0.4, 20, { isStatic: true, render: { fillStyle: '#777' }, angle: Math.PI / 12 }),
                Bodies.rectangle(width * 0.7, height * 0.6, width * 0.4, 20, { isStatic: true, render: { fillStyle: '#777' }, angle: -Math.PI / 12 }),
                Bodies.rectangle(width * 0.5, height * 0.85, width * 0.2, 20, { isStatic: true, render: { fillStyle: '#777' } })
            ];

            // ゴールエリア（緑色）
            const goalSize = Math.min(width, height) * 0.15;
            const goal = Bodies.rectangle(width * 0.9, height * 0.9, goalSize, goalSize, {
                isStatic: true,
                isSensor: true, // 物理的な衝突はしないが検知はする
                label: 'Goal',
                render: { fillStyle: '#4CAF50', opacity: 0.8 }
            });

            // 穴・トラップ（赤色）
            const holeSize = Math.min(width, height) * 0.12;
            const trap1 = Bodies.circle(width * 0.5, height * 0.5, holeSize/2, {
                isStatic: true,
                isSensor: true,
                label: 'Trap',
                render: { fillStyle: '#F44336' }
            });
            
            // 2つ目の罠（画面サイズが大きい場合のみ追加）
            let extraTraps = [];
            if (height > 600) {
                const trap2 = Bodies.circle(width * 0.2, height * 0.8, holeSize/2, {
                    isStatic: true,
                    isSensor: true,
                    label: 'Trap',
                    render: { fillStyle: '#F44336' }
                });
                extraTraps.push(trap2);
            }

            // ボール（プレイヤー）
            const ballRadius = Math.min(width, height) * 0.03;
            ball = Bodies.circle(width * 0.1, height * 0.1, ballRadius, {
                label: 'Ball',
                restitution: 0.5, // 跳ね返り係数
                friction: 0.05,
                density: 0.04,
                render: { fillStyle: '#2196F3' }
            });

            World.add(engine.world, [
                ...walls,
                ...obstacles,
                goal,
                trap1,
                ...extraTraps,
                ball
            ]);
        }

        // センサー許可リクエストとゲーム開始処理
        startBtn.addEventListener('click', async () => {
            // iOS 13+ 用の権限リクエスト
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        setupOrientationListener();
                        startGame();
                    } else {
                        alert('センサーの使用が許可されませんでした。');
                    }
                } catch (e) {
                    console.error(e);
                    alert('エラーが発生しました。');
                }
            } else {
                // Android や PC、古いiOS
                setupOrientationListener();
                startGame();
            }
        });

        function startGame() {
            uiLayer.classList.add('hidden');
            isGameActive = true;
            createLevel(); // レベルをリセット
        }

        // 傾きセンサーの設定
        function setupOrientationListener() {
            window.addEventListener('deviceorientation', handleOrientation);
        }

        // 傾きデータを重力に変換
        function handleOrientation(event) {
            if (!isGameActive) return;

            // beta: 前後の傾き (-180 ~ 180) -> Y軸
            // gamma: 左右の傾き (-90 ~ 90) -> X軸
            const { beta, gamma } = event;

            // 画面の向きによる補正（横持ち対応など）
            // ※今回は簡易的に縦持ち(Portrait)を基準にします
            
            // 値のクランプ（急激な動きを制限）と正規化
            const gravityX = clamp(gamma, -45, 45) / 45;
            const gravityY = clamp(beta, -45, 45) / 45;

            // 重力を適用
            engine.world.gravity.x = gravityX * 1.5;
            engine.world.gravity.y = gravityY * 1.5;
        }

        // PC用キーボード操作
        function handleKeyboard(e) {
            if (!isGameActive) return;
            const force = 0.005;
            
            switch(e.key) {
                case 'ArrowUp': engine.world.gravity.y = -1; break;
                case 'ArrowDown': engine.world.gravity.y = 1; break;
                case 'ArrowLeft': engine.world.gravity.x = -1; break;
                case 'ArrowRight': engine.world.gravity.x = 1; break;
                default: break;
            }
        }

        // 衝突判定
        function handleCollisions(event) {
            if (!isGameActive) return;

            const pairs = event.pairs;

            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA;
                const bodyB = pairs[i].bodyB;

                // ボールが含まれているかチェック
                let otherBody = null;
                if (bodyA.label === 'Ball') otherBody = bodyB;
                else if (bodyB.label === 'Ball') otherBody = bodyA;

                if (otherBody) {
                    if (otherBody.label === 'Goal') {
                        gameWin();
                    } else if (otherBody.label === 'Trap') {
                        gameOver();
                    }
                }
            }
        }

        function gameWin() {
            isGameActive = false;
            showResult("CLEAR!", "おめでとう！ゴールしました！", "#4CAF50");
        }

        function gameOver() {
            isGameActive = false;
            showResult("GAME OVER", "穴に落ちてしまいました...", "#F44336");
        }

        function showResult(title, desc, color) {
            titleText.textContent = title;
            titleText.style.color = color;
            descText.textContent = desc;
            startBtn.textContent = "もう一度遊ぶ";
            uiLayer.classList.remove('hidden');
        }

        function clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        function handleResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            render.canvas.width = width;
            render.canvas.height = height;
            if(!isGameActive) initGame(); // ゲーム中でなければ再初期化
        }

        // 初期化実行
        initGame();

    </script>
</body>
</html>

